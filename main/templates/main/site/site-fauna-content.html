{% load format %}
<style>
    .readme{
        min-width: 100px;
        white-space: nowrap;
    }
    tr>th:first-child,tr>td:first-child {
    position: sticky;
    left: 0;
    z-index: 50;
    }
    th{ vertical-align: bottom }

</style>
<div style="height: 40px;"></div>
<div class="my-2 panel" id="site_taxa_content">
    {% if request.user.is_authenticated %}
    <div class="panel-head p-2">
        <span
            class='btn tooltip tooltip-right modal_open'
            data-tooltip="Manage Fauna"
            hx-get="{% url 'main_modal_get' %}?{{request.GET|getstring}}"
            hx-vals='{"object":"layer_{{object.layer.first.pk}}","type":"faunal_tables"}'
            hx-target="#modal-blank"><i class="icon icon-plus"></i>
        </span>
    </div>
    {% endif %}
    <div class="panel-body p-0">
        <table class="table" style="margin-bottom: 150px;">
            <thead>
                <!--Header nr.1-->
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    {% for family in families %}
                        <th colspan="{{data|lookup:'header'|lookup:family|length}}">{{family}}</th>
                    {% endfor %}
                </tr>
                <!--Header nr.2-->
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    {% for sp in species %}
                    <td colspan="{{data|lookup:'header'|lookup:sp|length}}"><i>{{sp}}</i></td>
                    {% endfor %}
                </tr>
                <!--Header nr.3-->
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    {% for sp in species %}
                        {% for var in data|lookup:'header'|lookup:sp %}
                            <td>{{var}}</td>
                        {% endfor %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for analysis in analyses %}
                <tr>
                    <td class="{{analysis.layer.culture.classname}} p-2 readme">
                        <strong>{{analysis.layer.name}}</strong>
                    </td>
                    <td class="readme">
                        {% include 'main/reference/reference-popup.html' with ref=analysis.ref pos='right' %}
                    </td>
                    <td class="readme">
                        {{analysis.method}}
                    </td>
                    {% for sp in species %}
                        {% for var in data|lookup:'header'|lookup:sp %}
                        {% with val=data|lookup:'data'|lookup:analysis|lookup:sp|lookup:var|default:"" %}
                        <td class="heatmap" data-max="{{data|lookup:'max'|lookup:var}}">{{val}}</td>
                        {% endwith %}
                        {% endfor %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not data %}
    <div class="empty">
        <div class="empty-icon">
          <i class="icon icon-flag"></i>
        </div>
        <p class="empty-title h5">No Faunal Data imported</p>
    </div>
    {% endif %}
</div>

<script>
    $(document).ready(function(){
        $('.heatmap').each(function(){
            var max = $(this).attr('data-max')
            var val = $(this).html()
            var diff = val/max
            if(val){
                $(this).css('background', `rgba(51,170,51,${diff})`)
            }
        })
    });


</script>
